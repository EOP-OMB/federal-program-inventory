<!-- Dependencies -->
<script src="https://code.jquery.com/jquery-3.7.1.min.js" integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" crossorigin="anonymous"></script>
<link href="https://cdn.jsdelivr.net/npm/gridjs/dist/theme/mermaid.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/gridjs/dist/gridjs.umd.js"></script>

<!-- Custom styles -->
<style>
/* Grid.js styles */
.gridjs-table {
    width: 100%;
    border-collapse: collapse;
}
.gridjs-th {
    background-color: #f0f0f0;
    padding: 0.75rem;
    text-align: left;
    font-weight: bold;
}
.gridjs-td {
    padding: 0.75rem;
    border: 1px solid #ddd;
}
.gridjs-pagination {
    padding: 0.75rem;
    display: flex;
    justify-content: center;
    align-items: center;
    margin-top: 1rem;
}
.gridjs-pagination button {
    margin: 0 0.25rem;
    padding: 0.5rem 1rem;
    background-color: #fff;
    border: 1px solid #ddd;
    cursor: pointer;
}

/* Toggle styles */
.display-flex:hover {
    cursor: pointer;
}

.usa-icon.display-block {
    transition: transform 0.2s ease-in-out;
}

.display-flex.active .usa-icon.display-block {
    transform: rotate(90deg);
}
</style>

<!-- Script for Toggle, Checkbox Synchronization, and Grid Functionality with Sorting -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialize toggles, checkbox synchronization, and Grid.js with sorting
    initializeToggles();
    initializeCheckboxSync();
    initializeGrid();
});

function initializeToggles() {
    // Set up category and agency toggle buttons for showing/hiding subcategories
    const filterToggles = document.querySelectorAll('.toggle');
    filterToggles.forEach((toggle) => {
        toggle.addEventListener('click', function(event) {
            event.preventDefault();
            const childrenId = this.getAttribute('data-children-id');
            const childrenContainer = document.getElementById(childrenId);
            const icon = this.querySelector('use');

            // Toggle visibility of the child container
            if (childrenContainer.style.display === 'none' || childrenContainer.style.display === '') {
                childrenContainer.style.display = 'block';
                icon.setAttribute('xlink:href', '/assets/img/sprite.svg#expand_more');
            } else {
                childrenContainer.style.display = 'none';
                icon.setAttribute('xlink:href', '/assets/img/sprite.svg#navigate_next');
            }
        });
    });

    // Prevent checkbox clicks from triggering the toggle
    document.querySelectorAll('.usa-checkbox input[type="checkbox"]').forEach((checkbox) => {
        checkbox.addEventListener('click', function(event) {
            event.stopPropagation();
        });
    });
}

function initializeCheckboxSync() {
    // Handle checking/unchecking of all children when a parent checkbox is toggled
    const parentCheckboxes = document.querySelectorAll('.parent');

    parentCheckboxes.forEach((parentCheckbox) => {
        parentCheckbox.addEventListener('change', function() {
            const childrenId = this.id.replace('check-', 'children-for-check-');
            const childCheckboxes = document.querySelectorAll(`#${childrenId} .usa-checkbox input[type="checkbox"]`);

            childCheckboxes.forEach((childCheckbox) => {
                childCheckbox.checked = this.checked;
            });
        });
    });
}

function initializeGrid() {
    // Set up Grid.js with sorting enabled for columns
    const tableContainer = document.getElementById('programs-table');
    if (tableContainer) {
        let currentPage = 1;
        let currentSortField = 'title';
        let currentSortOrder = 'asc';

        const grid = new gridjs.Grid({
            columns: [
                { 
                    id: 'title',
                    name: 'Title',
                    sort: true,
                    formatter: (cell, row) => `${cell} (${row.cells[1].data})`
                },
                { id: 'cfda', name: 'CFDA', hidden: true },
                { 
                    id: 'agency', 
                    name: 'Agency', 
                    sort: true,
                    formatter: cell => cell?.title || ''
                },
                { 
                    id: 'objectives',
                    name: 'Objectives',
                    sort: true
                }
            ],
            pagination: { enabled: true, limit: 20 },
            sort: {
                multiColumn: false,
                server: {
                    url: (prev, columns) => {
                        if (columns.length) {
                            const fieldMap = {
                                0: 'title',
                                2: 'agency.title',
                                3: 'objectives'
                            };
                            currentSortField = fieldMap[columns[0].index] || 'title';
                            currentSortOrder = columns[0].direction === 1 ? 'asc' : 'desc';
                        }
                        return constructUrl();
                    }
                }
            },
            server: {
                url: constructUrl(),
                then: data => data.programs,
                total: data => data.count
            },
            className: {
                container: 'programs-table-container',
                table: 'usa-table',
                th: 'usa-table-header',
                td: 'usa-table-cell'
            }
        }).render(tableContainer);

        function constructUrl() {
            return `http://localhost:8000/api/search/programsTable?page=${currentPage}&page_size=10&sort_field=${currentSortField}&sort_order=${currentSortOrder}`;
        }
    }
}
</script>
