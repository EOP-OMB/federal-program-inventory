<script>
  // Set API URL with environment variable for production use
  const API_BASE_URL = "http://localhost:8000/api/search/programsTable";

  // Get URL search params to handle pagination, search, and sorting from URL
  let URLparams = (new URL(document.location)).searchParams;

  // Initialize an empty set for filtered programs
  var filteredProgramIds = new Set();
  var tablePrograms = [];

  // Helper function to fetch programs from the API
  async function fetchPrograms(queryParams = {}) {
    const url = new URL(API_BASE_URL);
    Object.keys(queryParams).forEach(key => url.searchParams.append(key, queryParams[key]));

    try {
      const response = await fetch(url);
      if (!response.ok) {
        throw new Error('Failed to fetch programs');
      }
      const data = await response.json();
      return data.programs || [];
    } catch (error) {
      console.error("Error fetching programs:", error);
      return [];
    }
  }

  // Initialize searchGrid for displaying programs data
  var searchGrid = new gridjs.Grid({
    columns: [
      { id: "cfda", name: "Number", hidden: true },
      {
        id: "title",
        name: "Name",
        width: '40%',
        formatter: (_, row) => gridjs.html(`<a href="${row.cells[4].data}" target="_blank">${row.cells[0].data + ' - ' + row.cells[1].data}</a>`)
      },
      { id: "agency", name: "Agency", width: '30%' },
      {
        id: "obligations",
        name: "Obligations (FY {{page.fiscal_year}})",
        width: '29%',
        formatter: (cell) => `${new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD', maximumFractionDigits: 2, notation: 'compact' }).format(cell)}`
      },
      { id: "permalink", name: "Link", hidden: true }
    ],
    style: { container: { overflow: 'hidden' } },
    sort: true,
    search: { ignoreHiddenColumns: false },
    pagination: { limit: 20 },
    data: []
  }).render(document.getElementById("programs-table"));

  // Function to update grid data based on filters, pagination, and sorting
  async function updateGrid(query = '', page = 1, pageSize = 20, sortField = "title", sortOrder = "asc") {
    tablePrograms = await fetchPrograms({
      query,
      page,
      page_size: pageSize,
      sort_field: sortField,
      sort_order: sortOrder
    });

    searchGrid.updateConfig({ data: tablePrograms }).forceRender();
    updateSummary();
  }

  // Function to calculate and display the total number and obligations for displayed programs
  function updateSummary() {
    document.getElementById('big-number-num-of-programs').innerHTML = tablePrograms.length.toLocaleString('en-US', { maximumFractionDigits: 0 });
    let totalObligations = tablePrograms.reduce((acc, program) => acc + (program.obligations || 0), 0);
    document.getElementById('big-number-obligations').innerHTML = totalObligations.toLocaleString('en-US', { style: 'currency', currency: 'USD', maximumFractionDigits: 2, notation: 'compact' });
  }

  // Filter handling: Add listeners to checkboxes for applying filters
  var filterInputs = document.getElementById('search-filters').getElementsByTagName('input');
  for (let i = 0; i < filterInputs.length; ++i) {
    filterInputs[i].addEventListener('change', () => applyFilters());
  }

  // Function to collect filters and apply them to the table
  function applyFilters() {
    let query = '';
    let selectedFilters = document.querySelectorAll('#search-filters input:checked');
    selectedFilters.forEach(filter => {
      query += `${filter.value} `;
    });

    updateGrid(query.trim());
  }

  // Add toggle functionality for filter sections
  var filterToggles = document.getElementById('search-filters').getElementsByClassName('toggle');
  for (let i = 0; i < filterToggles.length; ++i) {
    filterToggles[i].addEventListener('click', (event) => {
      let toggleButton = event.currentTarget;
      let toggleButtonUseContainer = toggleButton.getElementsByTagName('use')[0];
      let childrenContainer = document.getElementById(toggleButton.getAttribute('data-children-id'));
      if (childrenContainer.style.display === "none") {
        childrenContainer.style.display = "block";
        toggleButtonUseContainer.setAttributeNS('http://www.w3.org/1999/xlink', 'xlink:href', '/assets/img/sprite.svg#expand_more');
      } else {
        childrenContainer.style.display = "none";
        toggleButtonUseContainer.setAttributeNS('http://www.w3.org/1999/xlink', 'xlink:href', '/assets/img/sprite.svg#navigate_next');
      }
    });
  }

  // Initialize the grid with data on page load
  updateGrid();

</script>