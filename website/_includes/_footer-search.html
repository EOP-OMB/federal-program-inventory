<script>
  // Base API URL
  const API_BASE_URL = 'http://localhost:8000';
  
  // State management
  const state = {
    page: 1,
    pageSize: 20,
    sortField: 'title',
    sortOrder: 'asc',
    filters: {
      categories: [],
      agencySubAgency: [],
      assistanceTypes: [],
      applicantTypes: []
    },
    activeFilterType: null,
    expandedCategories: new Set(),
    expandedAgencies: new Set()
  };
  
  // Utility functions
  function formatCurrency(amount) {
    return new Intl.NumberFormat('en-US', {
      style: 'currency',
      currency: 'USD',
      minimumFractionDigits: 0,
      maximumFractionDigits: 0
    }).format(amount);
  }
  
  // Event handlers
  function handleFilterChange(filterType, value, checked) {
    if (!state.activeFilterType && checked) {
      state.activeFilterType = filterType;
    }
  
    if (!state.activeFilterType || filterType === state.activeFilterType) {
      if (checked) {
        state.filters[filterType] = [...state.filters[filterType], value];
      } else {
        state.filters[filterType] = state.filters[filterType].filter(v => v !== value);
        if (state.filters[filterType].length === 0) {
          state.activeFilterType = null;
        }
      }
      state.page = 1;
      fetchAndUpdateResults();
    }
  }
  
  function handleParentCategoryChange(filterType, parentValue, checked) {
    const childCheckboxes = document.querySelectorAll(`[data-parent="${parentValue}"] input[type="checkbox"]`);
    const childValues = Array.from(childCheckboxes).map(cb => cb.value);
    
    if (!state.activeFilterType && checked) {
      state.activeFilterType = filterType;
    }
  
    if (!state.activeFilterType || filterType === state.activeFilterType) {
      if (checked) {
        const newValues = childValues.filter(v => !state.filters[filterType].includes(v));
        state.filters[filterType] = [...state.filters[filterType], ...newValues];
      } else {
        state.filters[filterType] = state.filters[filterType].filter(v => !childValues.includes(v));
        if (state.filters[filterType].length === 0) {
          state.activeFilterType = null;
        }
      }
      
      childCheckboxes.forEach(cb => {
        cb.checked = checked;
      });
  
      state.page = 1;
      fetchAndUpdateResults();
    }
  }
  
  function toggleExpand(elementId, button) {
    const content = document.getElementById(elementId);
    if (content) {
      const isExpanded = content.style.display !== 'none';
      content.style.display = isExpanded ? 'none' : 'block';
      const icon = button.querySelector('img');
      if (icon) {
        icon.style.transform = isExpanded ? 'none' : 'rotate(90deg)';
      }
    }
  }
  
  function handleSort(field) {
    if (state.sortField === field) {
      state.sortOrder = state.sortOrder === 'asc' ? 'desc' : 'asc';
    } else {
      state.sortField = field;
      state.sortOrder = 'asc';
    }
    fetchAndUpdateResults();
  }
  
  function handlePageChange(newPage) {
    if (newPage >= 1) {
      state.page = newPage;
      fetchAndUpdateResults();
    }
  }
  
  // API interaction
  async function fetchAndUpdateResults() {
    const queryParams = new URLSearchParams({
      page: state.page,
      page_size: state.pageSize,
      sort_field: state.sortField,
      sort_order: state.sortOrder
    });
  
    // Add filters to query params
    Object.entries(state.filters).forEach(([key, values]) => {
      if (values.length > 0) {
        queryParams.append(key, values.join(','));
      }
    });
  
    try {
      const response = await fetch(`${API_BASE_URL}/search/programsTable?${queryParams}`);
      if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
      }
      const data = await response.json();
      updateUI(data);
    } catch (error) {
      console.error('Error fetching search results:', error);
    }
  }
  
  // UI update functions
  function updateUI(data) {
    updateTable(data.programs);
    updateFacets(data.facets);
    updatePagination(data.count);
    updateSummaryStats(data.count, data.total_obligations);
    updateSortIndicators();
  }
  
  function updateTable(programs) {
    const tableBody = document.getElementById('programs-table-body');
    if (!tableBody) return;
  
    tableBody.innerHTML = programs.map(program => `
      <tr>
        <td>
          <a href="${program.permalink}" class="usa-link">
            ${program.title}
          </a>
        </td>
        <td>${program.agency}</td>
        <td class="text-right">${formatCurrency(program.obligations)}</td>
      </tr>
    `).join('');
  }
  
  function updateFacets(facets) {
    Object.entries(facets).forEach(([filterType, values]) => {
      const container = document.getElementById(`${filterType}-list`);
      if (!container) return;
  
      const structure = window.filterStructure[container.dataset.structureType];
      if (!structure) return;
  
      let html = '';
  
      if (filterType === 'categories' || filterType === 'agencySubAgency') {
        // Handle hierarchical facets
        html = structure.map(parent => {
          const parentCount = values.find(v => v.key === parent.title)?.doc_count || 0;
          const isDisabled = state.activeFilterType && 
                            state.activeFilterType !== filterType && 
                            parentCount === 0;
  
          return `
            <div class="filter-group">
              <div class="display-flex">
                ${parent.sub_categories?.length ? `
                  <button class="toggle-button"
                          onclick="toggleExpand('${filterType}-${parent.title}', this)"
                          ${isDisabled ? 'disabled' : ''}>
                    <img class="usa-icon" src="/assets/img/navigate_next.svg">
                  </button>
                ` : ''}
                <div class="usa-checkbox">
                  <input class="usa-checkbox__input"
                         type="checkbox"
                         id="${filterType}-${parent.title}"
                         value="${parent.title}"
                         ${state.filters[filterType].includes(parent.title) ? 'checked' : ''}
                         ${isDisabled ? 'disabled' : ''}
                         onchange="handleParentCategoryChange('${filterType}', '${parent.title}', this.checked)">
                  <label class="usa-checkbox__label" for="${filterType}-${parent.title}">
                    ${parent.title} (${parentCount})
                  </label>
                </div>
              </div>
              ${parent.sub_categories?.length ? `
                <div id="${filterType}-${parent.title}"
                     class="subcategories margin-left-4"
                     style="display: ${state.expandedCategories.has(parent.title) ? 'block' : 'none'}">
                  ${parent.sub_categories.map(sub => {
                    const fullValue = `${parent.title} - ${sub.title}`;
                    const subCount = values.find(v => v.key === fullValue)?.doc_count || 0;
                    const isSubDisabled = state.activeFilterType && 
                                        state.activeFilterType !== filterType && 
                                        subCount === 0;
                    
                    return `
                      <div class="usa-checkbox" data-parent="${parent.title}">
                        <input class="usa-checkbox__input"
                               type="checkbox"
                               id="${filterType}-${fullValue}"
                               value="${fullValue}"
                               ${state.filters[filterType].includes(fullValue) ? 'checked' : ''}
                               ${isSubDisabled ? 'disabled' : ''}
                               onchange="handleFilterChange('${filterType}', '${fullValue}', this.checked)">
                        <label class="usa-checkbox__label" for="${filterType}-${fullValue}">
                          ${sub.title} (${subCount})
                        </label>
                      </div>
                    `;
                  }).join('')}
                </div>
              ` : ''}
            </div>
          `;
        }).join('');
      } else {
        // Handle flat facets
        html = values.map(facet => {
          const isDisabled = state.activeFilterType && 
                            state.activeFilterType !== filterType && 
                            facet.doc_count === 0;
          
          return `
            <div class="usa-checkbox">
              <input class="usa-checkbox__input"
                     type="checkbox"
                     id="${filterType}-${facet.key}"
                     value="${facet.key}"
                     ${state.filters[filterType].includes(facet.key) ? 'checked' : ''}
                     ${isDisabled ? 'disabled' : ''}
                     onchange="handleFilterChange('${filterType}', '${facet.key}', this.checked)">
              <label class="usa-checkbox__label" for="${filterType}-${facet.key}">
                ${facet.key} (${facet.doc_count})
              </label>
            </div>
          `;
        }).join('');
      }
  
      container.innerHTML = html;
    });
  }
  
  function updateSummaryStats(totalCount, totalObligations) {
    const programsElement = document.getElementById('big-number-num-of-programs');
    const obligationsElement = document.getElementById('big-number-obligations');
    
    if (programsElement) {
      programsElement.textContent = totalCount.toLocaleString();
    }
    
    if (obligationsElement) {
      obligationsElement.textContent = formatCurrency(totalObligations);
    }
  }
  
  function updatePagination(totalCount) {
    const container = document.querySelector('.usa-pagination__list');
    if (!container) return;
  
    const totalPages = Math.ceil(totalCount / state.pageSize);
    
    let html = `
      <li class="usa-pagination__item usa-pagination__arrow">
        <button class="usa-pagination__button usa-pagination__previous-page"
                ${state.page === 1 ? 'disabled' : ''}
                onclick="handlePageChange(${state.page - 1})">
          <img class="usa-icon" src="/assets/img/navigate_before.svg" alt="Previous page">
        </button>
      </li>
    `;
  
    for (let i = 1; i <= totalPages; i++) {
      if (
        i === 1 ||
        i === totalPages ||
        (i >= state.page - 2 && i <= state.page + 2)
      ) {
        html += `
          <li class="usa-pagination__item usa-pagination__page-no">
            <button class="usa-pagination__button ${i === state.page ? 'is-active' : ''}"
                    onclick="handlePageChange(${i})">
              ${i}
            </button>
          </li>
        `;
      } else if (
        i === state.page - 3 ||
        i === state.page + 3
      ) {
        html += `
          <li class="usa-pagination__item usa-pagination__overflow">
            <span>...</span>
          </li>
        `;
      }
    }
  
    html += `
      <li class="usa-pagination__item usa-pagination__arrow">
        <button class="usa-pagination__button usa-pagination__next-page"
                ${state.page === totalPages ? 'disabled' : ''}
                onclick="handlePageChange(${state.page + 1})">
          <img class="usa-icon" src="/assets/img/navigate_next.svg" alt="Next page">
        </button>
      </li>
    `;
  
    container.innerHTML = html;
  }
  
  function updateSortIndicators() {
    document.querySelectorAll('.sortable').forEach(header => {
      const field = header.getAttribute('data-sort');
      header.classList.remove('sort-asc', 'sort-desc');
      if (field === state.sortField) {
        header.classList.add(`sort-${state.sortOrder}`);
      }
    });
  }
  
  // Initialize the page
  document.addEventListener('DOMContentLoaded', () => {
    // Add click handlers to sortable headers
    document.querySelectorAll('.sortable').forEach(header => {
      header.addEventListener('click', () => {
        handleSort(header.getAttribute('data-sort'));
      });
    });
  
    // Initial data fetch
    fetchAndUpdateResults();
  });
  </script>
  
  <style>
  .toggle-button {
    background: none;
    border: none;
    padding: 0;
    cursor: pointer;
  }
  
  .toggle-button[disabled] {
    cursor: not-allowed;
    opacity: 0.5;
  }
  
  .toggle-button img {
    transition: transform 0.2s ease-in-out;
  }
  
  .usa-checkbox__input[disabled] + .usa-checkbox__label {
    color: #71767a;
    cursor: not-allowed;
  }
  
  .sortable {
    cursor: pointer;
  }
  
  .sortable::after {
    content: '';
    display: inline-block;
    margin-left: 0.5em;
  }
  
  .sort-asc::after {
    border-bottom: 4px solid currentColor;
    border-left: 4px solid transparent;
    border-right: 4px solid transparent;
  }
  
  .sort-desc::after {
    border-top: 4px solid currentColor;
    border-left: 4px solid transparent;
    border-right: 4px solid transparent;
  }
  </style>