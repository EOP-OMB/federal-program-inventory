<script>
  const apiBaseUrl = "http://localhost:8000/api";
  let currentPage = 1;
  const pageSize = 10;
  let currentSort = { field: "title", order: "asc" };
  let currentQuery = "";

  // Initialize filter states
  let selectedAgencySubAgency = [];
  let selectedCategorySubcategory = [];
  let selectedAssistanceTypes = [];
  let selectedApplicantTypes = [];

  // Initialize programs data
  let programs = [];
  let totalCount = 0;
  let totalObligations = 0;
  let globalProgramCount = 0;
  let globalTotalObligations = 0;

  // Sort field mapping
  const sortFieldMapping = {
    title: "title",
    obligations: "obligations",
  };

  function syncParentCheckboxStates() {
    // Sync agency parent checkboxes
    document
      .querySelectorAll('input[data-filter-type="agency"]')
      .forEach((parentCheckbox) => {
        const childrenId = parentCheckbox.dataset.childrenId;
        if (childrenId) {
          const childrenContainer = document.getElementById(childrenId);
          if (childrenContainer) {
            const children = childrenContainer.querySelectorAll(
              'input[data-filter-type="sub-agency"]'
            );
            const allChecked = Array.from(children).every(
              (child) => child.checked
            );
            parentCheckbox.checked = allChecked && children.length > 0;
          }
        }
      });

    // Sync category parent checkboxes
    document
      .querySelectorAll('input[data-filter-type="category"]')
      .forEach((parentCheckbox) => {
        const childrenId = parentCheckbox.dataset.childrenId;
        if (childrenId) {
          const childrenContainer = document.getElementById(childrenId);
          if (childrenContainer) {
            const children = childrenContainer.querySelectorAll(
              'input[data-filter-type="sub-category"]'
            );
            const allChecked = Array.from(children).every(
              (child) => child.checked
            );
            parentCheckbox.checked = allChecked && children.length > 0;
          }
        }
      });
  }

  function getCheckedFilters() {
    const filters = {
      agency: [],
      category: [],
      assistance: [],
      applicant: [],
    };

    // Process agency filters
    document
      .querySelectorAll('input[data-filter-type="agency"]')
      .forEach((parentCheckbox) => {
        const childrenId = parentCheckbox.dataset.childrenId;
        const childrenContainer = childrenId
          ? document.getElementById(childrenId)
          : null;
        const hasChildren =
          childrenContainer?.querySelectorAll('input[type="checkbox"]').length >
          0;

        if (parentCheckbox.checked) {
          // Add parent agency regardless of children
          filters.agency.push({
            type: "agency",
            title: parentCheckbox.dataset.agencyTitle,
            selectAll: hasChildren, // only mark as selectAll if it actually has children
          });

          // If it has children and is checked, add all children
          if (hasChildren) {
            childrenContainer
              .querySelectorAll('input[data-filter-type="sub-agency"]')
              .forEach((child) => {
                filters.agency.push({
                  type: "sub-agency",
                  parentTitle: parentCheckbox.dataset.agencyTitle,
                  title: child.dataset.subagencyTitle,
                });
              });
          }
        } else if (hasChildren) {
          // If parent isn't checked but has children, check for individually selected children
          childrenContainer
            .querySelectorAll('input[data-filter-type="sub-agency"]:checked')
            .forEach((child) => {
              filters.agency.push({
                type: "sub-agency",
                parentTitle: parentCheckbox.dataset.agencyTitle,
                title: child.dataset.subagencyTitle,
              });
            });
        }
      });
    // Helper function to process hierarchical checkboxes
    const processHierarchicalCheckboxes = (
      parentSelector,
      parentType,
      childType,
      getChildTitle
    ) => {
      document.querySelectorAll(parentSelector).forEach((parentCheckbox) => {
        const childrenId = parentCheckbox.dataset.childrenId;
        if (!childrenId) return;

        const childrenContainer = document.getElementById(childrenId);
        if (!childrenContainer) return;

        const children = childrenContainer.querySelectorAll(
          `input[data-filter-type="${childType}"]`
        );
        const checkedChildren = Array.from(children).filter(
          (child) => child.checked
        );

        // If parent is checked, it means "select all"
        if (parentCheckbox.checked) {
          if (parentType === "agency") {
            filters.agency.push({
              type: "agency",
              title: parentCheckbox.dataset.agencyTitle,
              selectAll: true,
            });
          } else if (parentType === "category") {
            filters.category.push({
              type: "category",
              title: parentCheckbox.dataset.categoryTitle,
              selectAll: true,
            });
          }
        }
        // If not all children are checked, add only the checked ones
        else if (checkedChildren.length > 0) {
          checkedChildren.forEach((childCheckbox) => {
            const parentTitle =
              parentType === "agency"
                ? childCheckbox.dataset.agencyTitle
                : childCheckbox.dataset.categoryTitle;

            const filter = {
              type: childType,
              parentTitle: parentTitle,
              title: getChildTitle(childCheckbox),
            };

            if (parentType === "agency") {
              filters.agency.push(filter);
            } else if (parentType === "category") {
              filters.category.push(filter);
            }
          });
        }
      });
    };

    // Process agency hierarchy
    processHierarchicalCheckboxes(
      'input[data-filter-type="agency"]',
      "agency",
      "sub-agency",
      (checkbox) => checkbox.dataset.subagencyTitle
    );

    // Process category hierarchy
    processHierarchicalCheckboxes(
      'input[data-filter-type="category"]',
      "category",
      "sub-category",
      (checkbox) => checkbox.dataset.subcategoryTitle
    );

    // Process assistance type filters (no hierarchy)
    document
      .querySelectorAll('input[data-filter-type="assistance"]')
      .forEach((checkbox) => {
        if (checkbox.checked) {
          filters.assistance.push({
            type: "assistance",
            title: checkbox.dataset.assistanceTitle,
          });
        }
      });

    // Process applicant type filters (no hierarchy)
    document
      .querySelectorAll('input[data-filter-type="applicant"]')
      .forEach((checkbox) => {
        if (checkbox.checked) {
          filters.applicant.push({
            type: "applicant",
            title: checkbox.dataset.applicantTitle,
          });
        }
      });

    return filters;
  }

  function encodeFiltersToUrl() {
    const params = new URLSearchParams();

    // Encode search query if present
    if (currentQuery) {
      params.set("q", currentQuery);
    }

    // Encode sort state
    params.set("sort", currentSort.field);
    params.set("order", currentSort.order);

    // Encode page number if not on first page
    if (currentPage > 1) {
      params.set("page", currentPage);
    }

    // Get current filter state
    const filters = getCheckedFilters();

    // Helper function to encode filter arrays
    const encodeFilterArray = (key, array) => {
      if (array && array.length > 0) {
        // Use base64 to make URLs shorter and handle special characters
        const encoded = btoa(JSON.stringify(array));
        params.set(key, encoded);
      }
    };

    // Encode each filter type
    Object.entries(filters).forEach(([key, value]) => {
      if (value.length > 0) {
        encodeFilterArray(key, value);
      }
    });

    // Update URL without reloading page
    const newUrl = `${window.location.pathname}?${params.toString()}`;
    window.history.pushState({ path: newUrl }, "", newUrl);
  }

  function decodeFiltersFromUrl() {
    const params = new URLSearchParams(window.location.search);

    // Helper function to decode filter arrays
    const decodeFilterArray = (key) => {
      const encoded = params.get(key);
      if (encoded) {
        try {
          return JSON.parse(atob(encoded));
        } catch (e) {
          console.error(`Error decoding ${key} filter:`, e);
          return [];
        }
      }
      return [];
    };

    // Restore search query
    currentQuery = params.get("q") || "";
    if (currentQuery) {
      const searchInput = document.querySelector('input[type="search"]');
      if (searchInput) {
        searchInput.value = currentQuery;
      }
    }

    // Restore sort state with defaults if not provided
    currentSort.field = params.get("sort") || "title";
    currentSort.order = params.get("order") || "asc";
    updateSortButtons();

    // Restore page number
    const page = params.get("page");
    if (page) {
      currentPage = parseInt(page, 10);
    }

    // Decode and process all filters
    const filters = {
      agency: decodeFilterArray("agency"),
      category: decodeFilterArray("category"),
      assistance: decodeFilterArray("assistance"),
      applicant: decodeFilterArray("applicant"),
    };

    // Update global filter arrays based on decoded data
    selectedAgencySubAgency = filters.agency.map((filter) => {
      if (filter.type === "sub-agency") {
        return `${filter.parentTitle} - ${filter.title}`;
      }
      return filter.title;
    });

    selectedCategorySubcategory = filters.category.map((filter) => {
      if (filter.type === "sub-category") {
        return `${filter.parentTitle} - ${filter.title}`;
      }
      return filter.title;
    });

    selectedAssistanceTypes = filters.assistance.map((filter) => filter.title);
    selectedApplicantTypes = filters.applicant.map((filter) => filter.title);

    // Update UI to reflect restored state
    updateCheckboxStates();
  }

  function updateCheckboxStates() {
    // Clear all checkboxes first
    document.querySelectorAll('input[type="checkbox"]').forEach((checkbox) => {
      checkbox.checked = false;
    });

    // Helper function to expand sections and show children
    const expandSection = (sectionId, shouldExpand = true) => {
      const section = document.getElementById(sectionId);
      if (section) {
        section.hidden = !shouldExpand;
        const button = document.querySelector(
          `[data-content-id="${sectionId}"]`
        );
        if (button) {
          button.setAttribute("aria-expanded", shouldExpand.toString());
          const icon = button.querySelector(".usa-icon use");
          if (icon) {
            icon.setAttribute(
              "xlink:href",
              shouldExpand
                ? "/assets/img/sprite.svg#expand_more"
                : "/assets/img/sprite.svg#navigate_next"
            );
          }
        }
      }
    };

    // Handle agency filters
    selectedAgencySubAgency.forEach((title) => {
      if (title.includes(" - ")) {
        const [parentTitle, subTitle] = title.split(" - ");

        // Expand agency section
        expandSection("agency-section", true);

        // Find and expand the specific agency's children container
        const parentCheckbox = document.querySelector(
          `input[data-filter-type="agency"][data-agency-title="${parentTitle}"]`
        );
        if (parentCheckbox) {
          const childrenId = parentCheckbox.getAttribute("data-children-id");
          if (childrenId) {
            expandSection(childrenId, true);
          }
        }

        // Check the child checkbox
        const childSelector = `input[data-filter-type="sub-agency"][data-agency-title="${parentTitle}"][data-subagency-title="${subTitle}"]`;
        const childCheckbox = document.querySelector(childSelector);
        if (childCheckbox) {
          childCheckbox.checked = true;
        }
      } else {
        // Expand agency section
        expandSection("agency-section", true);

        // Check the parent checkbox
        const parentCheckbox = document.querySelector(
          `input[data-filter-type="agency"][data-agency-title="${title}"]`
        );
        if (parentCheckbox) {
          parentCheckbox.checked = true;

          // If this parent has children, check them all
          const childrenId = parentCheckbox.getAttribute("data-children-id");
          if (childrenId) {
            const childrenContainer = document.getElementById(childrenId);
            if (childrenContainer) {
              const hasChildren =
                childrenContainer.querySelectorAll('input[type="checkbox"]')
                  .length > 0;
              if (hasChildren) {
                expandSection(childrenId, true);
                childrenContainer
                  .querySelectorAll('input[type="checkbox"]')
                  .forEach((child) => {
                    child.checked = true;
                  });
              }
            }
          }
        }
      }
    });

    // Handle category filters (similar to agency filters)
    selectedCategorySubcategory.forEach((title) => {
      if (title.includes(" - ")) {
        const [parentTitle, subTitle] = title.split(" - ");

        // Expand category section
        expandSection("categories-section", true);

        // Find and expand the specific category's children container
        const parentCheckbox = document.querySelector(
          `input[data-filter-type="category"][data-category-title="${parentTitle}"]`
        );
        if (parentCheckbox) {
          const childrenId = parentCheckbox.getAttribute("data-children-id");
          if (childrenId) {
            expandSection(childrenId, true);
          }
        }

        // Check the child checkbox
        const childSelector = `input[data-filter-type="sub-category"][data-category-title="${parentTitle}"][data-subcategory-title="${subTitle}"]`;
        const childCheckbox = document.querySelector(childSelector);
        if (childCheckbox) {
          childCheckbox.checked = true;
        }
      } else {
        // Expand category section
        expandSection("categories-section", true);

        // Check the parent checkbox
        const parentCheckbox = document.querySelector(
          `input[data-filter-type="category"][data-category-title="${title}"]`
        );
        if (parentCheckbox) {
          parentCheckbox.checked = true;

          // If this parent has children, check them all
          const childrenId = parentCheckbox.getAttribute("data-children-id");
          if (childrenId) {
            const childrenContainer = document.getElementById(childrenId);
            if (childrenContainer) {
              const hasChildren =
                childrenContainer.querySelectorAll('input[type="checkbox"]')
                  .length > 0;
              if (hasChildren) {
                expandSection(childrenId, true);
                childrenContainer
                  .querySelectorAll('input[type="checkbox"]')
                  .forEach((child) => {
                    child.checked = true;
                  });
              }
            }
          }
        }
      }
    });

    // Handle assistance types
    selectedAssistanceTypes.forEach((title) => {
      expandSection("program-type-section", true);
      const checkbox = document.querySelector(
        `input[data-filter-type="assistance"][data-assistance-title="${title}"]`
      );
      if (checkbox) {
        checkbox.checked = true;
      }
    });

    // Handle applicant types
    selectedApplicantTypes.forEach((title) => {
      expandSection("eligible-applicants-section", true);
      const checkbox = document.querySelector(
        `input[data-filter-type="applicant"][data-applicant-title="${title}"]`
      );
      if (checkbox) {
        checkbox.checked = true;
      }
    });

    // Sync parent checkboxes after all updates
    syncParentCheckboxStates();
  }

  function updateSortButtons() {
    const sortButtons = document.querySelectorAll(
      ".grid-col.display-flex.flex-justify-end .usa-button"
    );

    sortButtons.forEach((button) => {
      const buttonText = button.textContent.trim().toLowerCase();
      const isCurrentSort =
        (buttonText === "program name" && currentSort.field === "title") ||
        buttonText === currentSort.field;
      button.classList.toggle("usa-button--outline", !isCurrentSort);
    });
  }

  // Function to get correct sort field
  function getSortField(columnId) {
    return sortFieldMapping[columnId] || columnId || "title";
  }

  // Function to format currency in billions
  function formatObligations(amount) {
    const trillion = 1000000000000;
    const billion = 1000000000;

    if (amount >= trillion) {
      return `$${(amount / trillion).toFixed(2)}T`;
    } else {
      return `$${Math.round(amount / billion)}B`;
    }
  }

  function updatePagination(currentPage, totalPages) {
    // Update the info text
    const start = (currentPage - 1) * pageSize + 1;
    const end = Math.min(currentPage * pageSize, totalCount);

    document.getElementById("results-start").textContent =
      start.toLocaleString();
    document.getElementById("results-end").textContent = end.toLocaleString();
    document.getElementById("results-total").textContent =
      totalCount.toLocaleString();

    // Generate the page numbers
    generatePaginationNumbers(currentPage, totalPages);
  }

  function updateProgramCounts() {
    const filteredCountElement = document.getElementById("filtered-count");
    const globalCountElement = document.getElementById("global-count");

    if (filteredCountElement) {
      filteredCountElement.textContent = totalCount.toLocaleString();
    }

    if (globalCountElement) {
      globalCountElement.textContent = globalProgramCount.toLocaleString();
    }

    const filteredObligationsElement = document.getElementById(
      "filtered-obligations"
    );
    const globalObligationsElement =
      document.getElementById("global-obligations");

    if (filteredObligationsElement) {
      filteredObligationsElement.textContent =
        formatObligations(totalObligations);
    }

    if (globalObligationsElement) {
      globalObligationsElement.textContent = formatObligations(
        globalTotalObligations
      );
    }
  }

  function initializePaginationHandlers() {
    const paginationList = document.querySelector(".usa-pagination__list");

    // Event delegation for all pagination clicks
    paginationList.addEventListener("click", (event) => {
      event.preventDefault();
      const target = event.target.closest("a");
      if (!target) return;

      // Handle numbered page clicks
      if (target.classList.contains("usa-pagination__button")) {
        const newPage = parseInt(target.textContent);
        if (!isNaN(newPage) && newPage !== currentPage) {
          currentPage = newPage;
          encodeFiltersToUrl();
          fetchProgramsData();
        }
      }

      // Handle previous button
      if (target.classList.contains("usa-pagination__previous-page")) {
        if (currentPage > 1) {
          currentPage--;
          encodeFiltersToUrl();
          fetchProgramsData();
        }
      }

      // Handle next button
      if (target.classList.contains("usa-pagination__next-page")) {
        const totalPages = Math.ceil(totalCount / pageSize);
        if (currentPage < totalPages) {
          currentPage++;
          encodeFiltersToUrl();
          fetchProgramsData();
        }
      }
    });
  }

  function generatePaginationNumbers(currentPage, totalPages) {
    const paginationList = document.querySelector(".usa-pagination__list");
    const prevButton = paginationList.querySelector(
      ".usa-pagination__arrow:first-child"
    );
    const nextButton = paginationList.querySelector(
      ".usa-pagination__arrow:last-child"
    );

    // Remove existing page numbers
    const existingNumbers = paginationList.querySelectorAll(
      ".usa-pagination__page-no, .usa-pagination__overflow"
    );
    existingNumbers.forEach((item) => item.remove());

    let pages = [];

    pages.push(1);
    let rangeStart = Math.max(2, currentPage - 1);
    let rangeEnd = Math.min(totalPages - 1, currentPage + 1);

    if (rangeStart > 2) pages.push("...");

    for (let i = rangeStart; i <= rangeEnd; i++) {
      pages.push(i);
    }

    if (rangeEnd < totalPages - 1) pages.push("...");
    if (totalPages > 1) pages.push(totalPages);

    // Insert page numbers into DOM
    pages.forEach((page) => {
      const li = document.createElement("li");

      if (page === "...") {
        li.className = "usa-pagination__item usa-pagination__overflow";
        li.setAttribute("aria-label", "ellipsis indicating non-visible pages");
        li.innerHTML = "<span>â€¦</span>";
      } else {
        li.className = "usa-pagination__item usa-pagination__page-no";
        const a = document.createElement("a");
        a.href = "javascript:void(0);";
        a.className =
          "usa-pagination__button" +
          (page === currentPage ? " usa-current" : "");
        a.setAttribute("aria-label", `Page ${page}`);
        if (page === currentPage) {
          a.setAttribute("aria-current", "page");
        }
        a.textContent = page;
        li.appendChild(a);
      }

      paginationList.insertBefore(li, nextButton);
    });

    // Update disabled states
    const prevLink = prevButton.querySelector("a");
    const nextLink = nextButton.querySelector("a");

    if (currentPage === 1) {
      prevLink.classList.add("usa-pagination__link--disabled");
      prevLink.setAttribute("aria-disabled", "true");
    } else {
      prevLink.classList.remove("usa-pagination__link--disabled");
      prevLink.removeAttribute("aria-disabled");
    }

    if (currentPage === totalPages) {
      nextLink.classList.add("usa-pagination__link--disabled");
      nextLink.setAttribute("aria-disabled", "true");
    } else {
      nextLink.classList.remove("usa-pagination__link--disabled");
      nextLink.removeAttribute("aria-disabled");
    }
  }

  function renderPrograms(programs) {
    const programList = document.getElementById("program-list");
    const template = document.getElementById("program-template");

    programList.innerHTML = "";

    programs.slice(0, pageSize).forEach((program) => {
      const clone = template.content.cloneNode(true);

      clone.querySelector(".program-title").textContent = program.title;
      clone.querySelector(".program-title").href = program.permalink || "#";
      clone.querySelector(".program-popular-name").textContent =
        program.popularName || "";
      clone.querySelector(".program-agency").textContent =
        program.agency?.title || "";
      clone.querySelector(
        ".program-obligations"
      ).textContent = `${formatObligations(program.obligations)} in FY ${
        new Date().getFullYear() - 1
      } obligations`;

      const objectivesEl = clone.querySelector(".program-objectives");
      const readMoreBtn = clone.querySelector(".read-more-btn");

      objectivesEl.textContent = program.objectives || "";

      setTimeout(() => {
        const isOverflowing =
          objectivesEl.scrollHeight > objectivesEl.clientHeight;
        if (isOverflowing) {
          readMoreBtn.style.display = "inline-block";

          readMoreBtn.addEventListener("click", () => {
            const isExpanded = objectivesEl.classList.contains("expanded");
            objectivesEl.classList.toggle("expanded");
            readMoreBtn.textContent = isExpanded ? "...read more" : "read less";
          });
        }
      }, 0);

      programList.appendChild(clone);
    });
  }

  async function fetchProgramsData(keyword = currentQuery) {
    const requestBody = {
      query: keyword || "",
      page: currentPage,
      page_size: pageSize,
      sort_field: currentSort.field,
      sort_order: currentSort.order,
      agencySubAgency: selectedAgencySubAgency,
      categorySubcategory: selectedCategorySubcategory,
      assistanceTypes: selectedAssistanceTypes,
      applicantTypes: selectedApplicantTypes,
    };

    try {
      const response = await fetch(`${apiBaseUrl}/search/programsTable`, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify(requestBody),
      });

      if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
      }

      const data = await response.json();
      totalCount = data.count;
      totalObligations = data.total_obligations;
      globalProgramCount = data.global_program_count;
      globalTotalObligations = data.global_total_obligations;
      updatePagination(currentPage, Math.ceil(data.count / pageSize));
      updateProgramCounts();
      renderPrograms(data.programs);

      return data;
    } catch (error) {
      console.error("Error fetching programs:", error);
      return { programs: [], count: 0, total_obligations: 0 };
    }
  }

  // Add event listeners for filters
  const filterInputs = document
    .getElementById("search-filters")
    .getElementsByTagName("input");
  for (let input of filterInputs) {
    input.addEventListener("change", (event) => {
      handleFilterChange(event);
      currentPage = 1;
      fetchProgramsData();
    });
  }

  function handleFilterChange(event) {
    const input = event.target;
    const isChecked = input.checked;
    const filterType = input.getAttribute("data-filter-type");

    // First handle parent checkbox changes
    if (input.classList.contains("parent-checkbox")) {
      const childrenId = input.getAttribute("data-children-id");
      const parentTitle =
        filterType === "agency"
          ? input.getAttribute("data-agency-title")
          : input.getAttribute("data-category-title");

      // Handle parent checkbox
      const childrenContainer = childrenId
        ? document.getElementById(childrenId)
        : null;
      const hasChildren =
        childrenContainer?.querySelectorAll('input[type="checkbox"]').length >
        0;

      if (!hasChildren) {
        // Handle parent with no children
        if (filterType === "agency") {
          if (isChecked) {
            selectedAgencySubAgency.push(parentTitle);
          } else {
            selectedAgencySubAgency = selectedAgencySubAgency.filter(
              (item) => item !== parentTitle
            );
          }
        } else if (filterType === "category") {
          if (isChecked) {
            selectedCategorySubcategory.push(parentTitle);
          } else {
            selectedCategorySubcategory = selectedCategorySubcategory.filter(
              (item) => item !== parentTitle
            );
          }
        }
      } else {
        // Handle parent with children
        const children = childrenContainer.querySelectorAll(
          'input[type="checkbox"]'
        );

        // Check/uncheck all children
        children.forEach((child) => {
          child.checked = isChecked;
        });

        if (filterType === "agency") {
          if (isChecked) {
            selectedAgencySubAgency.push(parentTitle);
            // Add all child agencies
            children.forEach((child) => {
              const combinedAgencyTitle = `${parentTitle} - ${child.getAttribute(
                "data-subagency-title"
              )}`;
              if (!selectedAgencySubAgency.includes(combinedAgencyTitle)) {
                selectedAgencySubAgency.push(combinedAgencyTitle);
              }
            });
          } else {
            // Remove parent and all children
            selectedAgencySubAgency = selectedAgencySubAgency.filter(
              (item) => !item.startsWith(parentTitle)
            );
          }
        } else if (filterType === "category") {
          if (isChecked) {
            selectedCategorySubcategory.push(parentTitle);
            // Add all subcategories
            children.forEach((child) => {
              const combinedCategoryTitle = `${parentTitle} - ${child.getAttribute(
                "data-subcategory-title"
              )}`;
              if (
                !selectedCategorySubcategory.includes(combinedCategoryTitle)
              ) {
                selectedCategorySubcategory.push(combinedCategoryTitle);
              }
            });
          } else {
            // Remove parent and all children
            selectedCategorySubcategory = selectedCategorySubcategory.filter(
              (item) => !item.startsWith(parentTitle)
            );
          }
        }
      }
    } else {
      // Handle individual checkbox changes (child or standalone)
      switch (filterType) {
        case "agency":
          const agencyTitle = input.getAttribute("data-agency-title");
          if (isChecked) {
            selectedAgencySubAgency.push(agencyTitle);
          } else {
            selectedAgencySubAgency = selectedAgencySubAgency.filter(
              (item) =>
                item !== agencyTitle && !item.startsWith(`${agencyTitle} - `)
            );
          }
          break;
        case "sub-agency":
          const parentAgencyTitle = input.getAttribute("data-agency-title");
          const subAgencyTitle = input.getAttribute("data-subagency-title");
          const combinedAgencyTitle = `${parentAgencyTitle} - ${subAgencyTitle}`;
          if (isChecked) {
            selectedAgencySubAgency.push(combinedAgencyTitle);

            // Check if all siblings are checked to determine parent state
            const parentContainer = input.closest(
              '[id^="children-for-check-agency-"]'
            );
            if (parentContainer) {
              const siblings = parentContainer.querySelectorAll(
                'input[type="checkbox"]'
              );
              const allChecked = Array.from(siblings).every(
                (sib) => sib.checked
              );
              if (
                allChecked &&
                !selectedAgencySubAgency.includes(parentAgencyTitle)
              ) {
                selectedAgencySubAgency.push(parentAgencyTitle);
              }
            }
          } else {
            selectedAgencySubAgency = selectedAgencySubAgency.filter(
              (item) => item !== combinedAgencyTitle
            );
            // Remove parent from selection when any child is unchecked
            selectedAgencySubAgency = selectedAgencySubAgency.filter(
              (item) => item !== parentAgencyTitle
            );
          }
          break;
        case "category":
          const categoryTitle = input.getAttribute("data-category-title");
          if (isChecked) {
            selectedCategorySubcategory.push(categoryTitle);
          } else {
            selectedCategorySubcategory = selectedCategorySubcategory.filter(
              (item) =>
                item !== categoryTitle &&
                !item.startsWith(`${categoryTitle} - `)
            );
          }
          break;
        case "sub-category":
          const parentCategoryTitle = input.getAttribute("data-category-title");
          const subcategoryTitle = input.getAttribute("data-subcategory-title");
          const combinedCategoryTitle = `${parentCategoryTitle} - ${subcategoryTitle}`;
          if (isChecked) {
            selectedCategorySubcategory.push(combinedCategoryTitle);

            // Check if all siblings are checked to determine parent state
            const parentContainer = input.closest(
              '[id^="children-for-check-category-"]'
            );
            if (parentContainer) {
              const siblings = parentContainer.querySelectorAll(
                'input[type="checkbox"]'
              );
              const allChecked = Array.from(siblings).every(
                (sib) => sib.checked
              );
              if (
                allChecked &&
                !selectedCategorySubcategory.includes(parentCategoryTitle)
              ) {
                selectedCategorySubcategory.push(parentCategoryTitle);
              }
            }
          } else {
            selectedCategorySubcategory = selectedCategorySubcategory.filter(
              (item) => item !== combinedCategoryTitle
            );
            // Remove parent from selection when any child is unchecked
            selectedCategorySubcategory = selectedCategorySubcategory.filter(
              (item) => item !== parentCategoryTitle
            );
          }
          break;
        case "assistance":
          const assistanceTitle = input.getAttribute("data-assistance-title");
          if (isChecked) {
            selectedAssistanceTypes.push(assistanceTitle);
          } else {
            selectedAssistanceTypes = selectedAssistanceTypes.filter(
              (item) => item !== assistanceTitle
            );
          }
          break;
        case "applicant":
          const applicantTitle = input.getAttribute("data-applicant-title");
          if (isChecked) {
            selectedApplicantTypes.push(applicantTitle);
          } else {
            selectedApplicantTypes = selectedApplicantTypes.filter(
              (item) => item !== applicantTitle
            );
          }
          break;
      }
    }

    // Always sync checkbox states after changes
    syncParentCheckboxStates();
    encodeFiltersToUrl();

    // Fetch new data
    currentPage = 1;
    fetchProgramsData();
  }

  function initializeToggles() {
    const filterToggles = document.querySelectorAll(
      ".toggle.expandable-button"
    );
    filterToggles.forEach((toggle) => {
      toggle.addEventListener("click", function (event) {
        event.preventDefault();
        const contentId = this.getAttribute("data-content-id");
        const childrenContainer = document.getElementById(contentId);
        const icon = this.querySelector("use");

        if (childrenContainer) {
          childrenContainer.hidden = !childrenContainer.hidden;

          if (childrenContainer.hidden) {
            icon.setAttribute(
              "xlink:href",
              "/assets/img/sprite.svg#navigate_next"
            );
          } else {
            icon.setAttribute(
              "xlink:href",
              "/assets/img/sprite.svg#expand_more"
            );
          }
        }
      });
    });

    document
      .querySelectorAll('.usa-checkbox input[type="checkbox"]')
      .forEach((checkbox) => {
        checkbox.addEventListener("click", function (event) {
          event.stopPropagation();
        });
      });
  }

  function initializeCheckboxSync() {
    // Parent checkbox event listeners
    document.querySelectorAll(".parent-checkbox").forEach((parentCheckbox) => {
      parentCheckbox.addEventListener("change", function (e) {
        handleFilterChange(e);
      });
    });

    // Child checkbox event listeners
    document.querySelectorAll(".child-checkbox").forEach((childCheckbox) => {
      childCheckbox.addEventListener("change", function (e) {
        handleFilterChange(e);
      });
    });
  }

  function initializeCaretToggles() {
    const expandButtons = document.querySelectorAll(".usa-sidenav__button");

    expandButtons.forEach((button) => {
      button.addEventListener("click", function (e) {
        const contentId = this.getAttribute("data-content-id");
        const content = document.getElementById(contentId);
        const expanded = this.getAttribute("aria-expanded") === "true";

        this.setAttribute("aria-expanded", !expanded);

        if (content) {
          content.hidden = !content.hidden;
        }

        const icon = this.querySelector(".usa-icon");
        if (icon) {
          icon.style.transform = expanded ? "" : "rotate(180deg)";
          icon.style.transition = "transform 0.2s";
        }
      });
    });
  }

  function initializeSortButtons() {
    const sortButtons = document.querySelectorAll(
      ".grid-col.display-flex.flex-justify-end .usa-button"
    );

    updateSortButtons();

    sortButtons.forEach((button) => {
      const buttonText = button.textContent.trim().toLowerCase();
      const isCurrentSort = buttonText === currentSort.field;
      button.classList.toggle("usa-button--outline", !isCurrentSort);
    });

    sortButtons.forEach((button) => {
      button.addEventListener("click", async function () {
        // Remove outline class from all buttons
        sortButtons.forEach((btn) => {
          btn.classList.add("usa-button--outline");
        });

        // Remove outline class from clicked button
        this.classList.remove("usa-button--outline");

        // Determine which sort field to use based on button text
        const buttonText = this.textContent.trim().toLowerCase();
        const sortField =
          buttonText === "obligations" ? "obligations" : "title";

        // Toggle sort order if clicking the same field
        if (currentSort.field === sortField) {
          currentSort.order = currentSort.order === "asc" ? "desc" : "asc";
        } else {
          // Set new sort field and default to ascending
          currentSort.field = sortField;
          currentSort.order = "asc";
        }

        // Reset to first page when sorting
        currentPage = 1;

        // Fetch data with new sort
        await fetchProgramsData();
        encodeFiltersToUrl();
      });
    });
  }

  function initializeClearFiltersButton() {
    const clearFiltersBtn = document.querySelector(
      ".usa-button.usa-button--outline.text-bold"
    );
    if (clearFiltersBtn) {
      clearFiltersBtn.addEventListener("click", clearAllFilters);
    }
  }

  function clearAllFilters() {
    // Clear all checkbox inputs
    const allCheckboxes = document.querySelectorAll('input[type="checkbox"]');
    allCheckboxes.forEach((checkbox) => {
      checkbox.checked = false;
    });

    // Clear search input
    const searchInput = document.querySelector('input[type="search"]');
    if (searchInput) {
      searchInput.value = "";
    }

    // Reset all filter arrays
    selectedAgencySubAgency = [];
    selectedCategorySubcategory = [];
    selectedAssistanceTypes = [];
    selectedApplicantTypes = [];

    // Reset current query
    currentQuery = "";

    // Reset to first page
    currentPage = 1;

    // Reset sort to default
    currentSort = { field: "title", order: "asc" };

    // Reset sort button UI
    const sortButtons = document.querySelectorAll(
      ".grid-col.display-flex.flex-justify-end .usa-button"
    );
    sortButtons.forEach((button) => {
      const buttonText = button.textContent.trim().toLowerCase();
      button.classList.toggle(
        "usa-button--outline",
        buttonText !== "program name"
      );
    });

    window.history.pushState({}, "", window.location.pathname);
    // Re-fetch data with cleared filters and default sort
    fetchProgramsData();
  }

  function initializeSearchButton() {
    const searchForm = document.querySelector(".usa-search");
    const searchInput = searchForm?.querySelector('input[type="search"]');

    if (searchForm) {
      searchForm.addEventListener("submit", async function (event) {
        event.preventDefault();

        if (searchInput) {
          const keyword = searchInput.value;
          currentQuery = keyword;
          currentPage = 1;
          encodeFiltersToUrl();
          await fetchProgramsData(keyword);
        }
      });
    }
  }

  document.addEventListener("DOMContentLoaded", async function () {
    initializeCaretToggles();
    initializeToggles();
    initializeCheckboxSync();
    initializeSearchButton();
    initializePaginationHandlers();
    initializeSortButtons();
    initializeClearFiltersButton();

    // Decode filters from URL before making initial API call
    decodeFiltersFromUrl();

    const initialData = await fetchProgramsData();
  });
</script>
