<script>
  const apiBaseUrl = "";
  let currentPage = 1;
  const pageSize = 10;
  let currentSort = { field: "obligations", order: "desc" };
  let currentQuery = "";

  // Initialize filter states
  let selectedAgencySubAgency = [];
  let selectedCategorySubcategory = [];
  let selectedAssistanceTypes = [];
  let selectedApplicantTypes = [];

  // Initialize programs data
  let programs = [];
  let totalCount = 0;
  let totalObligations = 0;
  let globalProgramCount = 0;
  let globalTotalObligations = 0;

  // Initial filter state
  let initialFilterState = {
    query: "",
    page: 1,
    sort: { field: "obligations", order: "asc" },
    agencies: [],
    categories: [],
    assistanceTypes: [],
    applicantTypes: [],
  };

  // Sort field mapping
  const sortFieldMapping = {
    title: "title",
    obligations: "obligations",
  };

  function captureInitialState() {
    initialFilterState = {
      query: currentQuery,
      page: currentPage,
      sort: { ...currentSort },
      agencies: [...selectedAgencySubAgency],
      categories: [...selectedCategorySubcategory],
      assistanceTypes: [...selectedAssistanceTypes],
      applicantTypes: [...selectedApplicantTypes],
    };
  }

  function initializePaginationHandlers() {
    const paginationList = document.querySelector(".usa-pagination__list");

    paginationList.addEventListener("click", async (event) => {
      event.preventDefault();
      const target = event.target.closest("a");
      if (!target) return;

      let shouldUpdate = false;

      // Handle numbered page clicks
      if (target.classList.contains("usa-pagination__button")) {
        const newPage = parseInt(target.textContent);
        if (!isNaN(newPage) && newPage !== currentPage) {
          currentPage = newPage;
          shouldUpdate = true;
        }
      }

      // Handle previous button
      if (target.classList.contains("usa-pagination__previous-page")) {
        if (currentPage > 1) {
          currentPage--;
          shouldUpdate = true;
        }
      }

      // Handle next button
      if (target.classList.contains("usa-pagination__next-page")) {
        const totalPages = Math.ceil(totalCount / pageSize);
        if (currentPage < totalPages) {
          currentPage++;
          shouldUpdate = true;
        }
      }

      if (shouldUpdate) {
        encodeFiltersToUrl();
        await fetchProgramsData();
        updateClearFilterButton();
      }
    });
  }

  function arraysEqual(arr1, arr2) {
    if (arr1.length !== arr2.length) return false;
    return arr1.every((item, index) => item === arr2[index]);
  }

  // Helper function to check all enabled children of a parent
  const checkAllEnabledChildren = (parentTitle, type) => {
    if (type === "agency") {
      // First check if this agency exists as a child under "Other agencies"
      const otherAgenciesChildCheckbox = document.querySelector(
        `input[data-filter-type="sub-agency"][data-agency-title="Other agencies"][data-subagency-title="${parentTitle}"]`
      );

      if (otherAgenciesChildCheckbox && !otherAgenciesChildCheckbox.disabled) {
        otherAgenciesChildCheckbox.checked = true;
        selectedAgencySubAgency.push(`Other agencies - ${parentTitle}`);
        return; // Exit since we found it as a child of Other agencies
      }
    }

    // Now check for it as a parent checkbox
    const selector =
      type === "agency"
        ? `input[data-filter-type="agency"][data-agency-title="${parentTitle}"]`
        : `input[data-filter-type="category"][data-category-title="${parentTitle}"]`;

    const parentCheckbox = document.querySelector(selector);
    if (!parentCheckbox) return;

    // Check if this checkbox has actual children
    const childrenId = parentCheckbox.getAttribute("data-children-id");
    const childrenContainer = childrenId
      ? document.getElementById(childrenId)
      : null;
    const children = childrenContainer?.querySelectorAll(
      type === "agency"
        ? 'input[data-filter-type="sub-agency"]:not(:disabled)'
        : 'input[data-filter-type="sub-category"]:not(:disabled)'
    );

    // If no actual children found, treat as standalone
    if (!children || children.length === 0) {
      parentCheckbox.checked = true;
      if (type === "agency") {
        selectedAgencySubAgency.push(parentTitle);
      } else {
        selectedCategorySubcategory.push(parentTitle);
      }
      return;
    }

    // Process children if they exist
    children.forEach((child) => {
      child.checked = true;
      const subTitle =
        type === "agency"
          ? child.getAttribute("data-subagency-title")
          : child.getAttribute("data-subcategory-title");

      if (subTitle) {
        const combinedTitle = `${parentTitle} - ${subTitle}`;
        if (type === "agency") {
          if (!selectedAgencySubAgency.includes(combinedTitle)) {
            selectedAgencySubAgency.push(combinedTitle);
          }
        } else {
          if (!selectedCategorySubcategory.includes(combinedTitle)) {
            selectedCategorySubcategory.push(combinedTitle);
          }
        }
      }
    });
  };

  function hasFilterChanges() {
    const currentState = {
      query: currentQuery,
      page: currentPage,
      sort: currentSort,
      agencies: selectedAgencySubAgency,
      categories: selectedCategorySubcategory,
      assistanceTypes: selectedAssistanceTypes,
      applicantTypes: selectedApplicantTypes,
    };

    if (currentState.query !== initialFilterState.query) return true;

    const hasSortChange =
      currentState.sort.field !== initialFilterState.sort.field ||
      currentState.sort.order !== initialFilterState.sort.order;

    return (
      currentState.page !== initialFilterState.page ||
      hasSortChange ||
      !arraysEqual(currentState.agencies, initialFilterState.agencies) ||
      !arraysEqual(currentState.categories, initialFilterState.categories) ||
      !arraysEqual(
        currentState.assistanceTypes,
        initialFilterState.assistanceTypes
      ) ||
      !arraysEqual(
        currentState.applicantTypes,
        initialFilterState.applicantTypes
      )
    );
  }

  function updateClearFilterButton() {
    const clearFiltersBtn = document.querySelector(
      ".usa-button.usa-button--outline.text-bold"
    );
    if (clearFiltersBtn) {
      const hasChanges = hasFilterChanges();
      clearFiltersBtn.disabled = !hasChanges;
      clearFiltersBtn.classList.toggle("usa-button--disabled", !hasChanges);
    }
  }

  // Helper function to decompress filter data
  function decompressFilters(compressed) {
    if (!compressed || !compressed.codes) {
      return {
        agency: [],
        category: [],
        assistance: [],
        applicant: [],
      };
    }

    const codes = compressed.codes;
    const reverseMap = new Map(Object.entries(codes));

    const getTitle = (code) => reverseMap.get(code) || "";

    return {
      agency: (compressed.a || []).map((code) => {
        if (code.startsWith("s")) {
          const [parent, child] = code.slice(1).split(":");
          return {
            type: "sub-agency",
            parentTitle: getTitle(parent),
            title: getTitle(child),
          };
        }
        return {
          type: "agency",
          title: getTitle(code.slice(1).replace("*", "")),
          selectAll: code.endsWith("*"),
        };
      }),
      category: (compressed.c || []).map((code) => {
        if (code.startsWith("s")) {
          const [parent, child] = code.slice(1).split(":");
          return {
            type: "sub-category",
            parentTitle: getTitle(parent),
            title: getTitle(child),
          };
        }
        return {
          type: "category",
          title: getTitle(code.slice(1).replace("*", "")),
          selectAll: code.endsWith("*"),
        };
      }),
      assistance: (compressed.t || []).map((code) => ({
        type: "assistance",
        title: getTitle(code),
      })),
      applicant: (compressed.p || []).map((code) => ({
        type: "applicant",
        title: getTitle(code),
      })),
    };
  }

  function syncParentCheckboxStates() {
    // Sync parent checkboxes based on child states
    document
      .querySelectorAll('input[data-filter-type="agency"]')
      .forEach((parentCheckbox) => {
        const childrenId = parentCheckbox.dataset.childrenId;
        if (childrenId) {
          const childrenContainer = document.getElementById(childrenId);
          if (childrenContainer) {
            const children = childrenContainer.querySelectorAll(
              'input[data-filter-type="sub-agency"]:not(:disabled)'
            );
            const checkedChildren = Array.from(children).filter(
              (child) => child.checked
            );

            // Update parent checkbox state
            if (checkedChildren.length === 0) {
              parentCheckbox.checked = false;
              parentCheckbox.indeterminate = false;
            } else if (checkedChildren.length === children.length) {
              parentCheckbox.checked = true;
              parentCheckbox.indeterminate = false;
            } else {
              parentCheckbox.checked = false;
              parentCheckbox.indeterminate = true;
            }
          }
        }
      });

    document
      .querySelectorAll('input[data-filter-type="category"]')
      .forEach((parentCheckbox) => {
        const childrenId = parentCheckbox.dataset.childrenId;
        if (childrenId) {
          const childrenContainer = document.getElementById(childrenId);
          if (childrenContainer) {
            const children = childrenContainer.querySelectorAll(
              'input[data-filter-type="sub-category"]:not(:disabled)'
            );
            const checkedChildren = Array.from(children).filter(
              (child) => child.checked
            );

            if (checkedChildren.length === 0) {
              parentCheckbox.checked = false;
              parentCheckbox.indeterminate = false;
            } else if (checkedChildren.length === children.length) {
              parentCheckbox.checked = true;
              parentCheckbox.indeterminate = false;
            } else {
              parentCheckbox.checked = false;
              parentCheckbox.indeterminate = true;
            }
          }
        }
      });
  }
  function getCheckedFilters() {
    const filters = {
      agency: [],
      category: [],
      assistance: [],
      applicant: [],
    };

    // Process agency filters
    document
      .querySelectorAll('input[data-filter-type="agency"]:checked')
      .forEach((checkbox) => {
        const title = checkbox.getAttribute("data-agency-title");
        const childrenId = checkbox.getAttribute("data-children-id");
        const hasChildren =
          childrenId &&
          document
            .getElementById(childrenId)
            ?.querySelectorAll('input[type="checkbox"]').length > 0;

        filters.agency.push({
          type: "agency",
          title: title,
          selectAll: hasChildren,
        });
      });

    // Process sub-agencies
    document
      .querySelectorAll('input[data-filter-type="sub-agency"]:checked')
      .forEach((checkbox) => {
        filters.agency.push({
          type: "sub-agency",
          parentTitle: checkbox.getAttribute("data-agency-title"),
          title: checkbox.getAttribute("data-subagency-title"),
        });
      });

    // Process category filters
    document
      .querySelectorAll('input[data-filter-type="category"]:checked')
      .forEach((checkbox) => {
        const title = checkbox.getAttribute("data-category-title");
        const childrenId = checkbox.getAttribute("data-children-id");
        const hasChildren =
          childrenId &&
          document
            .getElementById(childrenId)
            ?.querySelectorAll('input[type="checkbox"]').length > 0;

        filters.category.push({
          type: "category",
          title: title,
          selectAll: hasChildren,
        });
      });

    // Process sub-categories
    document
      .querySelectorAll('input[data-filter-type="sub-category"]:checked')
      .forEach((checkbox) => {
        filters.category.push({
          type: "sub-category",
          parentTitle: checkbox.getAttribute("data-category-title"),
          title: checkbox.getAttribute("data-subcategory-title"),
        });
      });

    // Process assistance types
    document
      .querySelectorAll('input[data-filter-type="assistance"]:checked')
      .forEach((checkbox) => {
        filters.assistance.push({
          type: "assistance",
          title: checkbox.getAttribute("data-assistance-title"),
        });
      });

    // Process applicant types
    document
      .querySelectorAll('input[data-filter-type="applicant"]:checked')
      .forEach((checkbox) => {
        filters.applicant.push({
          type: "applicant",
          title: checkbox.getAttribute("data-applicant-title"),
        });
      });

    return filters;
  }

  function encodeFiltersToUrl() {
    const params = new URLSearchParams();

    // Encode search query if present
    if (currentQuery) {
      params.set("q", currentQuery);
    }

    // Encode sort state
    params.set("s", `${currentSort.field[0]}${currentSort.order[0]}`); // Compress sort params

    // Encode page number if not on first page
    if (currentPage > 1) {
      params.set("p", currentPage);
    }

    // Get and compress current filter state
    const filters = getCheckedFilters();
    const compressed = compressFilters(filters);

    if (Object.keys(compressed).some((k) => compressed[k].length > 0)) {
      params.set("f", btoa(JSON.stringify(compressed)));
    }

    // Update URL without reloading page
    const newUrl = `${window.location.pathname}?${params.toString()}`;
    window.history.pushState({ path: newUrl }, "", newUrl);
  }

  function decodeFiltersFromUrl() {
    const params = new URLSearchParams(window.location.search);

    // Restore search query
    currentQuery = params.get("q") || "";
    if (currentQuery) {
      const searchInput = document.querySelector('input[type="search"]');
      if (searchInput) {
        searchInput.value = currentQuery;
      }
    }

    // Restore sort state with default to obligations desc
    const sortParam = params.get("s") || "od";
    currentSort.field = sortParam[0] === "t" ? "title" : "obligations";
    currentSort.order = sortParam[1] === "a" ? "asc" : "desc";
    updateSortButtons();

    // Restore page number
    currentPage = parseInt(params.get("p")) || 1;

    // Reset filter arrays
    selectedAgencySubAgency = [];
    selectedCategorySubcategory = [];
    selectedAssistanceTypes = [];
    selectedApplicantTypes = [];

    // Decode and process filters
    try {
      const encodedFilters = params.get("f");
      if (encodedFilters) {
        const decodedData = JSON.parse(atob(encodedFilters));
        const mapping = decodedData.codes || {};

        // Process agencies
        if (decodedData.a && Array.isArray(decodedData.a)) {
          decodedData.a.forEach((code) => {
            if (!code) return;

            if (code.startsWith("s")) {
              // Handle sub-agency
              const [parentCode, childCode] = code.slice(1).split(":");
              const parentTitle = mapping[parentCode];
              const childTitle = mapping[childCode];
              if (parentTitle && childTitle) {
                selectedAgencySubAgency.push(`${parentTitle} - ${childTitle}`);
                const childCheckbox = document.querySelector(
                  `input[data-filter-type="sub-agency"][data-agency-title="${parentTitle}"][data-subagency-title="${childTitle}"]`
                );
                if (childCheckbox) {
                  childCheckbox.checked = true;
                }
              }
            } else if (code.startsWith("p")) {
              // Handle parent agency
              const agencyCode = code.slice(1).replace("*", "");
              const agencyTitle = mapping[agencyCode];
              if (agencyTitle) {
                checkAllEnabledChildren(agencyTitle, "agency");
              }
            }
          });
        }

        // Process categories
        if (decodedData.c && Array.isArray(decodedData.c)) {
          decodedData.c.forEach((code) => {
            if (!code) return;

            if (code.startsWith("s")) {
              // Handle sub-category
              const [parentCode, childCode] = code.slice(1).split(":");
              const parentTitle = mapping[parentCode];
              const childTitle = mapping[childCode];
              if (parentTitle && childTitle) {
                selectedCategorySubcategory.push(
                  `${parentTitle} - ${childTitle}`
                );
                const childCheckbox = document.querySelector(
                  `input[data-filter-type="sub-category"][data-category-title="${parentTitle}"][data-subcategory-title="${childTitle}"]`
                );
                if (childCheckbox) {
                  childCheckbox.checked = true;
                }
              }
            } else if (code.startsWith("p")) {
              // Handle parent category
              const categoryCode = code.slice(1).replace("*", "");
              const categoryTitle = mapping[categoryCode];
              if (categoryTitle) {
                checkAllEnabledChildren(categoryTitle, "category");
              }
            }
          });
        }

        // Process assistance types
        if (decodedData.t && Array.isArray(decodedData.t)) {
          decodedData.t.forEach((code) => {
            const assistanceTitle = mapping[code];
            if (assistanceTitle) {
              selectedAssistanceTypes.push(assistanceTitle);
              const checkbox = document.querySelector(
                `input[data-filter-type="assistance"][data-assistance-title="${assistanceTitle}"]`
              );
              if (checkbox) {
                checkbox.checked = true;
              }
            }
          });
        }

        // Process applicant types
        if (decodedData.p && Array.isArray(decodedData.p)) {
          decodedData.p.forEach((code) => {
            const applicantTitle = mapping[code];
            if (applicantTitle) {
              selectedApplicantTypes.push(applicantTitle);
              const checkbox = document.querySelector(
                `input[data-filter-type="applicant"][data-applicant-title="${applicantTitle}"]`
              );
              if (checkbox) {
                checkbox.checked = true;
              }
            }
          });
        }
      }
    } catch (e) {
      console.error("Error decoding filters:", e);
    }

    // Update UI states
    updateAccordionCounts();
    syncParentCheckboxStates();
  }

  function updateCheckboxStates() {
    // First reset all checkboxes
    document.querySelectorAll('input[type="checkbox"]').forEach((checkbox) => {
      checkbox.checked = false;
    });

    // Helper function to check checkbox WITHOUT expanding its section
    const checkBox = (selector) => {
      const checkbox = document.querySelector(selector);
      if (checkbox) {
        checkbox.checked = true;
      }
    };

    // Process agency filters
    selectedAgencySubAgency.forEach((title) => {
      if (title.includes(" - ")) {
        const [parentTitle, subTitle] = title.split(" - ");

        // Find and check child checkbox
        const childSelector = `input[data-filter-type="sub-agency"][data-agency-title="${parentTitle}"][data-subagency-title="${subTitle}"]`;
        checkBox(childSelector);
      } else {
        checkBox(
          `input[data-filter-type="agency"][data-agency-title="${title}"]`
        );
      }
    });

    // Process category filters
    selectedCategorySubcategory.forEach((title) => {
      if (title.includes(" - ")) {
        const [parentTitle, subTitle] = title.split(" - ");

        // Find and check child checkbox
        const childSelector = `input[data-filter-type="sub-category"][data-category-title="${parentTitle}"][data-subcategory-title="${subTitle}"]`;
        checkBox(childSelector);
      } else {
        checkBox(
          `input[data-filter-type="category"][data-category-title="${title}"]`
        );
      }
    });

    // Process assistance types
    selectedAssistanceTypes.forEach((title) => {
      checkBox(
        `input[data-filter-type="assistance"][data-assistance-title="${title}"]`
      );
    });

    // Process applicant types
    selectedApplicantTypes.forEach((title) => {
      checkBox(
        `input[data-filter-type="applicant"][data-applicant-title="${title}"]`
      );
    });

    // Sync parent checkbox states
    syncParentCheckboxStates();
  }

  function updateSortButtons() {
    const sortButtons = document.querySelectorAll(
      ".grid-col.display-flex.flex-justify-end .usa-button"
    );

    sortButtons.forEach((button) => {
      const buttonText = button.textContent.trim().toLowerCase();
      const isCurrentSort =
        (buttonText === "program name" && currentSort.field === "title") ||
        buttonText === currentSort.field;
      button.classList.toggle("usa-button--outline", !isCurrentSort);
    });
  }

  // Function to get correct sort field
  function getSortField(columnId) {
    return sortFieldMapping[columnId] || columnId || "title";
  }

  // Function to format currency in billions
  function formatObligations(amount) {
    const trillion = 1000000000000; // 1T
    const billion = 1000000000; // 1B
    const million = 1000000; // 1M
    const thousand = 1000; // 1K
    const hundred = 100; // 100

    // Handle 0 case
    if (amount === 0) {
      return "$0";
    }

    // Handle trillions
    if (amount >= trillion) {
      return `$${(amount / trillion).toFixed(2)}T`;
    }

    // Handle billions
    if (amount >= billion) {
      return `$${(amount / billion).toFixed(2)}B`;
    }

    // Handle millions
    if (amount >= million) {
      return `$${(amount / million).toFixed(2)}M`;
    }

    // Handle thousands
    if (amount >= thousand) {
      return `$${(amount / thousand).toFixed(2)}K`;
    }

    // Handle hundreds and smaller
    if (amount >= hundred) {
      return `$${amount.toFixed(2)}`;
    }

    // Handle small numbers (less than 100)
    return `$${amount.toFixed(2)}`;
  }

  function updatePagination(currentPage, totalPages) {
    // Update the info text
    const start = totalCount === 0 ? 0 : (currentPage - 1) * pageSize + 1;
    const end = Math.min(currentPage * pageSize, totalCount);

    document.getElementById("results-start").textContent =
      start.toLocaleString();
    document.getElementById("results-end").textContent = end.toLocaleString();
    document.getElementById("results-total").textContent =
      totalCount.toLocaleString();

    // If there are no results, hide or disable pagination
    const paginationList = document.querySelector(".usa-pagination__list");
    if (totalCount === 0) {
      if (paginationList) {
        paginationList.style.display = "none";
      }
      return;
    } else {
      if (paginationList) {
        paginationList.style.display = "";
      }
    }

    // Generate the page numbers
    generatePaginationNumbers(currentPage, totalPages);
  }

  // Update generatePaginationNumbers to also handle zero results
  function generatePaginationNumbers(currentPage, totalPages) {
    const paginationList = document.querySelector(".usa-pagination__list");
    if (!paginationList || totalPages === 0) return;

    const prevButton = paginationList.querySelector(
      ".usa-pagination__arrow:first-child"
    );
    const nextButton = paginationList.querySelector(
      ".usa-pagination__arrow:last-child"
    );

    // Remove existing page numbers
    const existingNumbers = paginationList.querySelectorAll(
      ".usa-pagination__page-no, .usa-pagination__overflow"
    );
    existingNumbers.forEach((item) => item.remove());

    // If there are no pages, disable both navigation buttons and return
    if (totalPages === 0) {
      if (prevButton) {
        const prevLink = prevButton.querySelector("a");
        prevLink.classList.add("usa-pagination__link--disabled");
        prevLink.setAttribute("aria-disabled", "true");
      }
      if (nextButton) {
        const nextLink = nextButton.querySelector("a");
        nextLink.classList.add("usa-pagination__link--disabled");
        nextLink.setAttribute("aria-disabled", "true");
      }
      return;
    }

    let pages = [];

    pages.push(1);
    let rangeStart = Math.max(2, currentPage - 1);
    let rangeEnd = Math.min(totalPages - 1, currentPage + 1);

    if (rangeStart > 2) pages.push("...");

    for (let i = rangeStart; i <= rangeEnd; i++) {
      pages.push(i);
    }

    if (rangeEnd < totalPages - 1) pages.push("...");
    if (totalPages > 1) pages.push(totalPages);

    // Insert page numbers into DOM
    pages.forEach((page) => {
      const li = document.createElement("li");

      if (page === "...") {
        li.className = "usa-pagination__item usa-pagination__overflow";
        li.setAttribute("aria-label", "ellipsis indicating non-visible pages");
        li.innerHTML = "<span>…</span>";
      } else {
        li.className = "usa-pagination__item usa-pagination__page-no";
        const a = document.createElement("a");
        a.href = "javascript:void(0);";
        a.className =
          "usa-pagination__button" +
          (page === currentPage ? " usa-current" : "");
        a.setAttribute("aria-label", `Page ${page}`);
        if (page === currentPage) {
          a.setAttribute("aria-current", "page");
        }
        a.textContent = page;
        li.appendChild(a);
      }

      paginationList.insertBefore(li, nextButton);
    });

    // Update disabled states for navigation buttons
    const prevLink = prevButton.querySelector("a");
    const nextLink = nextButton.querySelector("a");

    if (currentPage === 1) {
      prevLink.classList.add("usa-pagination__link--disabled");
      prevLink.setAttribute("aria-disabled", "true");
    } else {
      prevLink.classList.remove("usa-pagination__link--disabled");
      prevLink.removeAttribute("aria-disabled");
    }

    if (currentPage === totalPages) {
      nextLink.classList.add("usa-pagination__link--disabled");
      nextLink.setAttribute("aria-disabled", "true");
    } else {
      nextLink.classList.remove("usa-pagination__link--disabled");
      nextLink.removeAttribute("aria-disabled");
    }
  }

  function updateProgramCounts() {
    const filteredCountElement = document.getElementById("filtered-count");
    const globalCountElement = document.getElementById("global-count");

    if (filteredCountElement) {
      filteredCountElement.textContent = totalCount.toLocaleString();
    }

    if (globalCountElement) {
      globalCountElement.textContent = globalProgramCount.toLocaleString();
    }

    const filteredObligationsElement = document.getElementById(
      "filtered-obligations"
    );
    const globalObligationsElement =
      document.getElementById("global-obligations");

    if (filteredObligationsElement) {
      filteredObligationsElement.textContent =
        formatObligations(totalObligations);
    }

    if (globalObligationsElement) {
      globalObligationsElement.textContent = formatObligations(
        globalTotalObligations
      );
    }
  }

  function initializePaginationHandlers() {
    const paginationList = document.querySelector(".usa-pagination__list");

    paginationList.addEventListener("click", (event) => {
      event.preventDefault();
      const target = event.target.closest("a");
      if (!target) return;

      let shouldUpdate = false;

      // Handle numbered page clicks
      if (target.classList.contains("usa-pagination__button")) {
        const newPage = parseInt(target.textContent);
        if (!isNaN(newPage) && newPage !== currentPage) {
          currentPage = newPage;
          shouldUpdate = true;
        }
      }

      // Handle previous button
      if (target.classList.contains("usa-pagination__previous-page")) {
        if (currentPage > 1) {
          currentPage--;
          shouldUpdate = true;
        }
      }

      // Handle next button
      if (target.classList.contains("usa-pagination__next-page")) {
        const totalPages = Math.ceil(totalCount / pageSize);
        if (currentPage < totalPages) {
          currentPage++;
          shouldUpdate = true;
        }
      }

      if (shouldUpdate) {
        encodeFiltersToUrl();
        fetchProgramsData();
        updateClearFilterButton();
      }
    });
  }

  function generatePaginationNumbers(currentPage, totalPages) {
    const paginationList = document.querySelector(".usa-pagination__list");
    const prevButton = paginationList.querySelector(
      ".usa-pagination__arrow:first-child"
    );
    const nextButton = paginationList.querySelector(
      ".usa-pagination__arrow:last-child"
    );

    // Remove existing page numbers
    const existingNumbers = paginationList.querySelectorAll(
      ".usa-pagination__page-no, .usa-pagination__overflow"
    );
    existingNumbers.forEach((item) => item.remove());

    let pages = [];

    pages.push(1);
    let rangeStart = Math.max(2, currentPage - 1);
    let rangeEnd = Math.min(totalPages - 1, currentPage + 1);

    if (rangeStart > 2) pages.push("...");

    for (let i = rangeStart; i <= rangeEnd; i++) {
      pages.push(i);
    }

    if (rangeEnd < totalPages - 1) pages.push("...");
    if (totalPages > 1) pages.push(totalPages);

    // Insert page numbers into DOM
    pages.forEach((page) => {
      const li = document.createElement("li");

      if (page === "...") {
        li.className = "usa-pagination__item usa-pagination__overflow";
        li.setAttribute("aria-label", "ellipsis indicating non-visible pages");
        li.innerHTML = "<span>…</span>";
      } else {
        li.className = "usa-pagination__item usa-pagination__page-no";
        const a = document.createElement("a");
        a.href = "javascript:void(0);";
        a.className =
          "usa-pagination__button" +
          (page === currentPage ? " usa-current" : "");
        a.setAttribute("aria-label", `Page ${page}`);
        if (page === currentPage) {
          a.setAttribute("aria-current", "page");
        }
        a.textContent = page;
        li.appendChild(a);
      }

      paginationList.insertBefore(li, nextButton);
    });

    // Update disabled states
    const prevLink = prevButton.querySelector("a");
    const nextLink = nextButton.querySelector("a");

    if (currentPage === 1) {
      prevLink.classList.add("usa-pagination__link--disabled");
      prevLink.setAttribute("aria-disabled", "true");
    } else {
      prevLink.classList.remove("usa-pagination__link--disabled");
      prevLink.removeAttribute("aria-disabled");
    }

    if (currentPage === totalPages) {
      nextLink.classList.add("usa-pagination__link--disabled");
      nextLink.setAttribute("aria-disabled", "true");
    } else {
      nextLink.classList.remove("usa-pagination__link--disabled");
      nextLink.removeAttribute("aria-disabled");
    }
  }

  function renderPrograms(programs) {
    const programList = document.getElementById("program-list");
    const template = document.getElementById("program-template");

    programList.innerHTML = "";

    programs.slice(0, pageSize).forEach((program) => {
      const clone = template.content.cloneNode(true);

      clone.querySelector(".program-title").textContent = program.title;
      clone.querySelector(".program-title").href = program.permalink || "#";

      const popularNameDiv = clone.querySelector(
        "[data-popular-name-container]"
      );
      if (!program.popularName || program.popularName.trim() === "") {
        popularNameDiv.remove();
      } else {
        clone.querySelector(".program-popular-name").textContent =
          program.popularName;
      }

      clone.querySelector(".program-agency").textContent =
        program.agency?.title || "";
      clone.querySelector(
        ".program-obligations"
      ).textContent = `${formatObligations(program.obligations)} in FY 2022 expeditures`;

      const objectivesEl = clone.querySelector(".program-objectives");
      const readMoreBtn = clone.querySelector(".read-more-btn");

      objectivesEl.textContent = program.objectives || "";

      setTimeout(() => {
        const isOverflowing =
          objectivesEl.scrollHeight > objectivesEl.clientHeight;
        if (isOverflowing) {
          readMoreBtn.style.display = "inline-block";

          readMoreBtn.addEventListener("click", () => {
            const isExpanded = objectivesEl.classList.contains("expanded");
            objectivesEl.classList.toggle("expanded");
            readMoreBtn.textContent = isExpanded ? "...read more" : "read less";
          });
        }
      }, 0);

      programList.appendChild(clone);
    });
  }

  async function fetchProgramsData(keyword = currentQuery) {
    const requestBody = {
      query: keyword || "",
      page: currentPage,
      page_size: pageSize,
      sort_field: currentSort.field,
      sort_order: currentSort.order,
      agencySubAgency: selectedAgencySubAgency,
      categorySubcategory: selectedCategorySubcategory,
      assistanceTypes: selectedAssistanceTypes,
      applicantTypes: selectedApplicantTypes,
    };

    try {
      const response = await fetch(`${apiBaseUrl}/api/search/programsTable`, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify(requestBody),
      });

      if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
      }

      const data = await response.json();
      totalCount = data.count;
      totalObligations = data.total_obligations;
      globalProgramCount = data.global_program_count;
      globalTotalObligations = data.global_total_obligations;
      updatePagination(currentPage, Math.ceil(data.count / pageSize));
      updateProgramCounts();
      renderPrograms(data.programs);

      return data;
    } catch (error) {
      console.error("Error fetching programs:", error);
      return { programs: [], count: 0, total_obligations: 0 };
    }
  }

  // Add event listeners for filters
  const filterInputs = document
    .getElementById("search-filters")
    .getElementsByTagName("input");
  for (let input of filterInputs) {
    input.addEventListener("change", (event) => {
      input.addEventListener("change", handleFilterChange);
    });
  }

  function handleFilterChange(event) {
    const input = event.target;

    // Prevent changes to disabled checkboxes
    if (input.disabled || input.closest(".usa-checkbox.disabled")) {
      event.preventDefault();
      event.stopPropagation();
      return;
    }

    const isChecked = input.checked;
    const filterType = input.getAttribute("data-filter-type");

    // Handle parent checkbox changes
    if (filterType === "agency" || filterType === "category") {
      const childrenId = input.getAttribute("data-children-id");
      const parentTitle =
        filterType === "agency"
          ? input.getAttribute("data-agency-title")
          : input.getAttribute("data-category-title");

      const childrenContainer = childrenId
        ? document.getElementById(childrenId)
        : null;
      const children = childrenContainer
        ? childrenContainer.querySelectorAll(
            'input[type="checkbox"]:not(:disabled)'
          )
        : [];

      // Reset indeterminate state when parent is clicked
      input.indeterminate = false;

      if (isChecked) {
        // Add parent selection only if it has no children
        if (children.length === 0) {
          if (filterType === "agency") {
            selectedAgencySubAgency.push(parentTitle);
          } else if (filterType === "category") {
            selectedCategorySubcategory.push(parentTitle);
          }
        }

        // Add enabled child selections
        children.forEach((child) => {
          if (!child.disabled) {
            const subTitle =
              filterType === "agency"
                ? child.getAttribute("data-subagency-title")
                : child.getAttribute("data-subcategory-title");
            const combinedTitle = `${parentTitle} - ${subTitle}`;
            if (
              filterType === "agency" &&
              !selectedAgencySubAgency.includes(combinedTitle)
            ) {
              selectedAgencySubAgency.push(combinedTitle);
            } else if (
              filterType === "category" &&
              !selectedCategorySubcategory.includes(combinedTitle)
            ) {
              selectedCategorySubcategory.push(combinedTitle);
            }
          }
        });
      } else {
        // Remove parent and enabled child selections while preserving disabled children
        const disabledSelections = [];
        children.forEach((child) => {
          if (child.disabled && child.checked) {
            const subTitle =
              filterType === "agency"
                ? child.getAttribute("data-subagency-title")
                : child.getAttribute("data-subcategory-title");
            const combinedTitle = `${parentTitle} - ${subTitle}`;
            disabledSelections.push(combinedTitle);
          }
        });

        if (filterType === "agency") {
          selectedAgencySubAgency = selectedAgencySubAgency.filter((item) => {
            if (item === parentTitle) return false; // Remove parent filter
            if (item.startsWith(`${parentTitle} - `)) {
              return disabledSelections.includes(item); // Preserve disabled children
            }
            return true;
          });
        } else if (filterType === "category") {
          selectedCategorySubcategory = selectedCategorySubcategory.filter(
            (item) => {
              if (item === parentTitle) return false; // Remove parent filter
              if (item.startsWith(`${parentTitle} - `)) {
                return disabledSelections.includes(item); // Preserve disabled children
              }
              return true;
            }
          );
        }
      }

      // Update checkbox states for enabled children
      children.forEach((child) => {
        if (!child.disabled) {
          child.checked = isChecked;
        }
      });
    } else {
      // Handle individual checkbox changes (child or standalone)
      switch (filterType) {
        case "sub-agency":
          const parentAgencyTitle = input.getAttribute("data-agency-title");
          const subAgencyTitle = input.getAttribute("data-subagency-title");
          const combinedAgencyTitle = `${parentAgencyTitle} - ${subAgencyTitle}`;
          if (isChecked) {
            selectedAgencySubAgency.push(combinedAgencyTitle);

            // Check if all enabled siblings are checked to determine parent state
            const parentContainer = input.closest(
              '[id^="children-for-check-agency-"]'
            );
            if (parentContainer) {
              const siblings = parentContainer.querySelectorAll(
                'input[type="checkbox"]'
              );
              const allEnabledChecked = Array.from(siblings).every(
                (sib) => sib.disabled || sib.checked
              );
              if (
                allEnabledChecked &&
                !selectedAgencySubAgency.includes(parentAgencyTitle)
              ) {
                selectedAgencySubAgency.push(parentAgencyTitle);
              }
            }
          } else {
            selectedAgencySubAgency = selectedAgencySubAgency.filter(
              (item) => item !== combinedAgencyTitle
            );
            // Remove parent from selection when any enabled child is unchecked
            selectedAgencySubAgency = selectedAgencySubAgency.filter(
              (item) => item !== parentAgencyTitle
            );
          }
          break;

        case "sub-category":
          const parentCategoryTitle = input.getAttribute("data-category-title");
          const subcategoryTitle = input.getAttribute("data-subcategory-title");
          const combinedCategoryTitle = `${parentCategoryTitle} - ${subcategoryTitle}`;
          if (isChecked) {
            selectedCategorySubcategory.push(combinedCategoryTitle);

            // Check if all enabled siblings are checked to determine parent state
            const parentContainer = input.closest(
              '[id^="children-for-check-category-"]'
            );
            if (parentContainer) {
              const siblings = parentContainer.querySelectorAll(
                'input[type="checkbox"]'
              );
              const allEnabledChecked = Array.from(siblings).every(
                (sib) => sib.disabled || sib.checked
              );
              if (
                allEnabledChecked &&
                !selectedCategorySubcategory.includes(parentCategoryTitle)
              ) {
                selectedCategorySubcategory.push(parentCategoryTitle);
              }
            }
          } else {
            selectedCategorySubcategory = selectedCategorySubcategory.filter(
              (item) => item !== combinedCategoryTitle
            );
            // Remove parent from selection when any enabled child is unchecked
            selectedCategorySubcategory = selectedCategorySubcategory.filter(
              (item) => item !== parentCategoryTitle
            );
          }
          break;

        case "assistance":
          const assistanceTitle = input.getAttribute("data-assistance-title");
          if (isChecked) {
            selectedAssistanceTypes.push(assistanceTitle);
          } else {
            selectedAssistanceTypes = selectedAssistanceTypes.filter(
              (item) => item !== assistanceTitle
            );
          }
          break;

        case "applicant":
          const applicantTitle = input.getAttribute("data-applicant-title");
          if (isChecked) {
            selectedApplicantTypes.push(applicantTitle);
          } else {
            selectedApplicantTypes = selectedApplicantTypes.filter(
              (item) => item !== applicantTitle
            );
          }
          break;
      }
    }

    // Reset the current page and update states
    currentPage = 1;

    updateClearFilterButton();

    // Sync checkbox states
    syncParentCheckboxStates();
    updateAccordionCounts();

    // Update filters and fetch new data
    encodeFiltersToUrl();
    fetchProgramsData();
  }

  function initializeToggles() {
    const filterToggles = document.querySelectorAll(
      ".toggle.expandable-button"
    );
    filterToggles.forEach((toggle) => {
      toggle.addEventListener("click", function (event) {
        event.preventDefault();
        const contentId = this.getAttribute("data-content-id");
        const childrenContainer = document.getElementById(contentId);
        const icon = this.querySelector("use");

        if (childrenContainer) {
          childrenContainer.hidden = !childrenContainer.hidden;

          if (childrenContainer.hidden) {
            icon.setAttribute(
              "xlink:href",
              "/assets/img/sprite.svg#navigate_next"
            );
          } else {
            icon.setAttribute(
              "xlink:href",
              "/assets/img/sprite.svg#expand_more"
            );
          }
        }
      });
    });

    document
      .querySelectorAll('.usa-checkbox input[type="checkbox"]')
      .forEach((checkbox) => {
        checkbox.addEventListener("click", function (event) {
          event.stopPropagation();
        });
      });
  }

  function initializeCheckboxSync() {
    // Parent checkbox event listeners
    document.querySelectorAll(".parent-checkbox").forEach((parentCheckbox) => {
      parentCheckbox.addEventListener("change", function (e) {
        handleFilterChange(e);
      });
    });

    // Child checkbox event listeners
    document.querySelectorAll(".child-checkbox").forEach((childCheckbox) => {
      childCheckbox.addEventListener("change", function (e) {
        handleFilterChange(e);
      });
    });
  }

  function initializeCaretToggles() {
    const expandButtons = document.querySelectorAll(".usa-sidenav__button");

    expandButtons.forEach((button) => {
      button.addEventListener("click", function (e) {
        const contentId = this.getAttribute("data-content-id");
        const content = document.getElementById(contentId);
        const expanded = this.getAttribute("aria-expanded") === "true";

        this.setAttribute("aria-expanded", !expanded);

        if (content) {
          content.hidden = !content.hidden;
        }

        const icon = this.querySelector(".usa-icon");
        if (icon) {
          icon.style.transform = expanded ? "" : "rotate(180deg)";
          icon.style.transition = "transform 0.2s";
        }
      });
    });
  }

  function initializeSortButtons() {
    const sortButtons = document.querySelectorAll(
      ".grid-col.display-flex.flex-justify-end .usa-button"
    );

    // Set initial button states
    sortButtons.forEach((button) => {
      const buttonText = button.textContent.trim().toLowerCase();
      if (buttonText === "obligations") {
        button.classList.remove("usa-button--outline");
      } else {
        button.classList.add("usa-button--outline");
      }
    });

    sortButtons.forEach((button) => {
      button.addEventListener("click", async function () {
        // Remove outline class from all buttons
        sortButtons.forEach((btn) => {
          btn.classList.add("usa-button--outline");
        });

        // Remove outline class from clicked button
        this.classList.remove("usa-button--outline");

        // Determine which sort field to use based on button text
        const buttonText = this.textContent.trim().toLowerCase();
        const sortField =
          buttonText === "obligations" ? "obligations" : "title";

        // Toggle sort order if clicking the same field
        if (currentSort.field === sortField) {
          currentSort.order = currentSort.order === "asc" ? "desc" : "asc";
        } else {
          // Set new sort field and default order based on field type
          currentSort.field = sortField;
          currentSort.order = sortField === "obligations" ? "desc" : "asc";
        }

        // Reset to first page when sorting
        currentPage = 1;

        // Update URL and fetch data
        encodeFiltersToUrl();
        await fetchProgramsData();

        // Update clear filters button
        updateClearFilterButton();
      });
    });
  }

  function initializeClearFiltersButton() {
    const clearFiltersBtn = document.querySelector(
      ".usa-button.usa-button--outline.text-bold"
    );
    if (clearFiltersBtn) {
      clearFiltersBtn.addEventListener("click", clearAllFilters);
    }
  }

  function clearAllFilters() {
    // Clear all checkbox inputs
    const allCheckboxes = document.querySelectorAll('input[type="checkbox"]');
    allCheckboxes.forEach((checkbox) => {
      checkbox.checked = false;
      checkbox.indeterminate = false;
    });

    updateAccordionCounts();

    // Clear search input
    const searchInput = document.querySelector('input[type="search"]');
    if (searchInput) {
      searchInput.value = "";
    }

    // Reset all filter arrays
    selectedAgencySubAgency = [];
    selectedCategorySubcategory = [];
    selectedAssistanceTypes = [];
    selectedApplicantTypes = [];

    // Reset current query
    currentQuery = "";

    // Reset to first page
    currentPage = 1;

    // Reset sort to default
    currentSort = { field: "obligations", order: "desc" };

    // Reset sort button UI
    const sortButtons = document.querySelectorAll(
      ".grid-col.display-flex.flex-justify-end .usa-button"
    );
    sortButtons.forEach((button) => {
      const buttonText = button.textContent.trim().toLowerCase();
      if (buttonText === "obligations") {
        button.classList.remove("usa-button--outline");
      } else {
        button.classList.add("usa-button--outline");
      }
    });

    window.history.pushState({}, "", window.location.pathname);
    // Re-fetch data with cleared filters and default sort
    captureInitialState();
    updateClearFilterButton();
    fetchProgramsData();
  }

  function initializeSearchButton() {
    const searchForm = document.querySelector(".usa-search");
    const searchInput = searchForm?.querySelector('input[type="search"]');

    if (searchForm) {
      searchForm.addEventListener("submit", async function (event) {
        event.preventDefault();

        if (searchInput) {
          const keyword = searchInput.value;
          currentQuery = keyword;
          currentPage = 1;
          encodeFiltersToUrl();
          await fetchProgramsData(keyword);
          updateClearFilterButton();
        }
      });
    }

    if (searchInput) {
      // Update currentQuery immediately on input
      searchInput.addEventListener("input", (event) => {
        currentQuery = event.target.value;
        if (!initialFilterState.query) {
          updateClearFilterButton();
        }
      });
    }
  }

  function updateAccordionCounts() {
    // Update Agency count
    const agencyButton = document.querySelector(
      '[data-content-id="agency-section"]'
    );
    if (agencyButton) {
      // Count sub-agencies
      const agencyChecks = document.querySelectorAll(
        'input[data-filter-type="sub-agency"]:checked'
      );

      // Count both standalone agencies and parent agencies with no children
      const parentAgencyChecks = document.querySelectorAll(
        'input[data-filter-type="agency"]:checked'
      );
      const parentCount = Array.from(parentAgencyChecks).filter((checkbox) => {
        const childrenId = checkbox.getAttribute("data-children-id");
        // Count if it has no children container or the container is empty
        return (
          !childrenId ||
          !document
            .getElementById(childrenId)
            ?.querySelectorAll('input[type="checkbox"]').length
        );
      }).length;

      const totalAgencyCount = agencyChecks.length + parentCount;

      const spanElement = agencyButton.querySelector("span");
      if (spanElement) {
        const baseText = "Agency";
        spanElement.textContent =
          totalAgencyCount > 0 ? `${baseText} (${totalAgencyCount})` : baseText;
      }
    }

    // Update Categories count (only counting subcategories)
    const categoryButton = document.querySelector(
      '[data-content-id="categories-section"]'
    );
    if (categoryButton) {
      const categoryChecks = document.querySelectorAll(
        'input[data-filter-type="sub-category"]:checked'
      );
      const count = categoryChecks.length;

      const spanElement = categoryButton.querySelector("span");
      if (spanElement) {
        const baseText = "Categories";
        spanElement.textContent =
          count > 0 ? `${baseText} (${count})` : baseText;
      }
    }

    // Update Program Type count
    const programTypeButton = document.querySelector(
      '[data-content-id="program-type-section"]'
    );
    if (programTypeButton) {
      const programTypeChecks = document.querySelectorAll(
        'input[data-filter-type="assistance"]:checked'
      );
      const count = programTypeChecks.length;

      const spanElement = programTypeButton.querySelector("span");
      if (spanElement) {
        const baseText = "Program type";
        spanElement.textContent =
          count > 0 ? `${baseText} (${count})` : baseText;
      }
    }

    // Update Eligible Applicants count
    const applicantButton = document.querySelector(
      '[data-content-id="eligible-applicants-section"]'
    );
    if (applicantButton) {
      const applicantChecks = document.querySelectorAll(
        'input[data-filter-type="applicant"]:checked'
      );
      const count = applicantChecks.length;

      const spanElement = applicantButton.querySelector("span");
      if (spanElement) {
        const baseText = "Eligible applicants";
        spanElement.textContent =
          count > 0 ? `${baseText} (${count})` : baseText;
      }
    }
  }

  document.addEventListener("DOMContentLoaded", async function () {
    initializeCaretToggles();
    initializeToggles();
    initializeCheckboxSync();
    initializeSearchButton();
    initializePaginationHandlers();
    initializeSortButtons();
    initializeClearFiltersButton();

    updateAccordionCounts();

    // Handle browser navigation
    window.addEventListener("popstate", async function () {
      captureInitialState();
      decodeFiltersFromUrl();
      await fetchProgramsData();
      updateClearFilterButton();
    });

    // Initial load
    try {
      // Decode filters and fetch data
      captureInitialState();
      decodeFiltersFromUrl();
      await fetchProgramsData();
      updateClearFilterButton();
    } catch (error) {
      console.error("Error during initialization:", error);
    }
  });
</script>
